{% extends "base.html" %}

{% block title %}Record Payout - IqubLedger{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="bg-gradient-to-r from-purple-500 to-indigo-600 rounded-2xl p-8 text-white mb-8">
        <h1 class="text-3xl font-bold mb-2">Record Iqub Payout</h1>
        <p class="text-purple-100 text-lg">
            Officially document the lump sum payment received by a member.
        </p>
        <p class="text-purple-100 mt-2">
            <i class="fas fa-shield-alt mr-1"></i>
            This transaction is <strong>atomic</strong> and permanent.
        </p>
    </div>

    <!-- Balance Information -->
    <div class="bg-indigo-50 border-l-4 border-indigo-600 p-6 rounded-lg mb-8">
        <div class="flex justify-between items-center">
            <div>
                <p class="text-sm font-medium text-indigo-700">Current Group Balance</p>
                <p class="text-3xl font-bold text-indigo-900 mt-1">
                    {{ "{:,.2f}".format(total_balance) }} Birr
                </p>
                <p class="text-xs text-indigo-600 mt-1">
                    This is the maximum available fund for disbursement.
                </p>
            </div>
            <div class="text-right">
                <div class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-white text-indigo-800">
                    <i class="fas fa-users mr-1"></i>
                    {{ members|length }} members
                </div>
            </div>
        </div>
    </div>

    <!-- Payout Form -->
    <div class="bg-white p-8 rounded-2xl shadow-xl border border-gray-100">
        <form class="space-y-6" action="/payout" method="POST">
            <!-- Member Selection -->
            <div>
                <label for="member_id" class="block text-sm font-medium text-gray-700 mb-1">
                    Member Receiving Payout
                </label>
                <select id="member_id" name="member_id" required
                        class="mt-1 block w-full pl-3 pr-10 py-3 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg shadow-sm transition duration-150"
                        onchange="updateMemberBalance()">
                    <option value="">-- Select Member --</option>
                    {% for member in members %}
                    <option value="{{ member.id }}" data-balance="{{ member.balance }}">
                        {{ member.name }} (Balance: {{ "{:,.2f}".format(member.balance) }} Birr)
                    </option>
                    {% endfor %}
                </select>
                <div id="member-balance-info" class="mt-2 hidden">
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-700">
                            Member's current balance: <span id="member-balance" class="font-bold">0.00</span> Birr
                        </p>
                    </div>
                </div>
            </div>

            <!-- Payout Amount -->
            <div>
                <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">
                    Payout Amount (in Birr)
                </label>
                <div class="mt-1 relative rounded-md shadow-sm">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <span class="text-gray-500 sm:text-sm"> Birr</span>
                    </div>
                    <input type="number" name="amount" id="amount" step="0.01" min="1" required
                           class="focus:ring-indigo-500 focus:border-indigo-500 block w-full pl-12 pr-3 py-3 sm:text-lg border-gray-300 rounded-lg font-bold text-gray-900 transition duration-150"
                           placeholder="e.g., 2000.00"
                           oninput="validateAmount()">
                </div>
                <p id="amount-validation" class="mt-1 text-sm text-gray-500">
                    Enter the payout amount
                </p>
            </div>

            <!-- Payout Date -->
            <div>
                <label for="payout_date" class="block text-sm font-medium text-gray-700 mb-1">
                    Date of Payout
                </label>
                <input type="date" name="payout_date" id="payout_date" required
                       class="focus:ring-indigo-500 focus:border-indigo-500 block w-full pr-4 py-3 sm:text-lg border-gray-300 rounded-lg transition duration-150"
                       value="{{ today_date }}"
                       max="{{ today_date }}">
            </div>

            <!-- Reference -->
            <div>
                <label for="reference" class="block text-sm font-medium text-gray-700 mb-1">
                    Reference / Description
                </label>
                <textarea id="reference" name="reference" rows="3"
                          class="mt-1 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-lg transition duration-150"
                          placeholder="e.g., 'Cycle 1 Payout', 'Emergency Disbursement', 'Monthly Distribution'"></textarea>
                <p class="mt-1 text-sm text-gray-500">
                    Provide a clear reference for this payout transaction
                </p>
            </div>

            <!-- Transaction Preview -->
            <div id="transaction-preview" class="hidden">
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Transaction Preview</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Member:</span>
                            <span class="font-medium" id="preview-member">—</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Current Balance:</span>
                            <span class="font-medium" id="preview-current-balance">0.00 Birr</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Payout Amount:</span>
                            <span class="font-bold text-purple-700" id="preview-amount">0.00 Birr</span>
                        </div>
                        <div class="flex justify-between border-t pt-2">
                            <span class="text-gray-600">New Balance:</span>
                            <span class="font-bold text-indigo-700" id="preview-new-balance">0.00 Birr</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Date:</span>
                            <span class="font-medium">{{ today_date }}</span>
                        </div>
                    </div>
                    <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded">
                        <p class="text-sm text-yellow-800">
                            <i class="fas fa-exclamation-triangle mr-1"></i>
                            <strong>Atomic Transaction:</strong> Both balance update and transaction record will be processed together.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Atomic Transaction Warning -->
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-database text-yellow-400"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-yellow-700">
                            <strong>Atomic Database Transaction:</strong> 
                            This operation ensures data consistency by performing both the balance update and transaction recording as a single unit.
                            If any part fails, the entire transaction is rolled back.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div>
                <button type="submit" id="submit-btn"
                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-lg text-lg font-medium text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition duration-150 transform hover:scale-[1.01]"
                        disabled>
                    <svg class="h-6 w-6 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2z" />
                    </svg>
                    Confirm Payout Transaction
                </button>
            </div>

            <!-- Navigation Links -->
            <div class="flex justify-between pt-4">
                <a href="/dashboard" class="text-gray-600 hover:text-gray-900 font-medium">
                    <i class="fas fa-arrow-left mr-1"></i> Back to Dashboard
                </a>
                <a href="/withdraw" class="text-indigo-600 hover:text-indigo-800 font-medium">
                    Process Regular Withdrawal <i class="fas fa-arrow-right ml-1"></i>
                </a>
            </div>
        </form>
    </div>
</div>

<script>
let selectedMemberBalance = 0;
let selectedMemberName = '';

function updateMemberBalance() {
    const select = document.getElementById('member_id');
    const option = select.options[select.selectedIndex];
    const infoDiv = document.getElementById('member-balance-info');
    const previewDiv = document.getElementById('transaction-preview');
    
    if (option.value) {
        selectedMemberBalance = parseFloat(option.dataset.balance);
        selectedMemberName = option.text.split(' (')[0];
        
        // Show member balance info
        infoDiv.classList.remove('hidden');
        document.getElementById('member-balance').textContent = 
            selectedMemberBalance.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        
        // Update preview if amount is entered
        updatePreview();
    } else {
        infoDiv.classList.add('hidden');
        previewDiv.classList.add('hidden');
        selectedMemberBalance = 0;
        selectedMemberName = '';
    }
    
    validateForm();
}

function validateAmount() {
    const amountInput = document.getElementById('amount');
    const amount = parseFloat(amountInput.value) || 0;
    const validationText = document.getElementById('amount-validation');
    
    if (amount <= 0) {
        validationText.innerHTML = '<span class="text-red-600">Amount must be positive</span>';
        return false;
    }
    
    if (amount > total_balance) {
        validationText.innerHTML = `<span class="text-red-600">Insufficient group funds. Available: ${total_balance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} Birr</span>`;
        return false;
    }
    
    if (amount > selectedMemberBalance) {
        validationText.innerHTML = `<span class="text-red-600">Member has insufficient balance. Available: ${selectedMemberBalance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} Birr</span>`;
        return false;
    }
    
    validationText.innerHTML = '<span class="text-green-600">✓ Amount is valid</span>';
    updatePreview();
    validateForm();
    return true;
}

function updatePreview() {
    const amountInput = document.getElementById('amount');
    const amount = parseFloat(amountInput.value) || 0;
    const previewDiv = document.getElementById('transaction-preview');
    
    if (selectedMemberName && amount > 0) {
        previewDiv.classList.remove('hidden');
        
        document.getElementById('preview-member').textContent = selectedMemberName;
        document.getElementById('preview-current-balance').textContent = 
            selectedMemberBalance.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }) + ' Birr';
        document.getElementById('preview-amount').textContent = 
            amount.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }) + ' Birr';
        
        const newBalance = selectedMemberBalance - amount;
        document.getElementById('preview-new-balance').textContent = 
            newBalance.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }) + ' Birr';
    } else {
        previewDiv.classList.add('hidden');
    }
}

function validateForm() {
    const memberSelect = document.getElementById('member_id');
    const amountInput = document.getElementById('amount');
    const submitBtn = document.getElementById('submit-btn');
    
    const isMemberSelected = memberSelect.value !== '';
    const amount = parseFloat(amountInput.value) || 0;
    const isAmountValid = amount > 0 && amount <= total_balance && amount <= selectedMemberBalance;
    
    if (isMemberSelected && isAmountValid) {
        submitBtn.disabled = false;
        submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    } else {
        submitBtn.disabled = true;
        submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Set max date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('payout_date').max = today;
    
    // Set up event listeners
    document.getElementById('member_id').addEventListener('change', updateMemberBalance);
    document.getElementById('amount').addEventListener('input', validateAmount);
});
</script>
{% endblock %}
