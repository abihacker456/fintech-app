{% extends "base.html" %}

{% block title %}Enable 2FA - IqubLedger{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900">
            <i class="fas fa-shield-alt text-purple-600 mr-2"></i>
            Enable Two-Factor Authentication
        </h1>
        <p class="mt-2 text-lg text-gray-600">
            Add an extra layer of security to your account
        </p>
        <div class="mt-4 inline-flex items-center px-4 py-2 rounded-full bg-purple-100 text-purple-800">
            <i class="fas fa-user-shield mr-2"></i>
            Recommended for all users
        </div>
    </div>

    <!-- Setup Steps -->
    <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Setup Instructions</h2>
        
        <!-- Step 1: Download App -->
        <div class="mb-8">
            <div class="flex items-center mb-4">
                <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center mr-3">
                    <span class="text-white font-bold">1</span>
                </div>
                <h3 class="text-xl font-bold text-gray-900">Download Authenticator App</h3>
            </div>
            <p class="text-gray-600 mb-4">
                Install one of these authenticator apps on your mobile device:
            </p>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="flex items-center mb-2">
                        <i class="fab fa-google text-blue-600 text-xl mr-2"></i>
                        <span class="font-bold">Google Authenticator</span>
                    </div>
                    <p class="text-sm text-gray-600">Available on iOS and Android</p>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-lock text-purple-600 text-xl mr-2"></i>
                        <span class="font-bold">Authy</span>
                    </div>
                    <p class="text-sm text-gray-600">Cloud backup available</p>
                </div>
            </div>
        </div>

        <!-- Step 2: Scan QR Code -->
        <div class="mb-8">
            <div class="flex items-center mb-4">
                <div class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center mr-3">
                    <span class="text-white font-bold">2</span>
                </div>
                <h3 class="text-xl font-bold text-gray-900">Scan QR Code</h3>
            </div>
            <p class="text-gray-600 mb-4">
                Open your authenticator app and scan this QR code:
            </p>
            
            <div class="text-center">
                {% if qr_code %}
                <div class="inline-block p-4 bg-white border border-gray-300 rounded-lg">
                    <img src="data:image/png;base64,{{ qr_code }}" 
                         alt="QR Code for 2FA Setup" 
                         class="w-48 h-48 mx-auto">
                </div>
                {% else %}
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
                    <span class="text-yellow-800">QR code generation failed. Please use the manual method.</span>
                </div>
                {% endif %}
            </div>
            
            <!-- Manual Entry -->
            <div class="mt-6 bg-gray-50 p-4 rounded-lg">
                <h4 class="font-bold text-gray-900 mb-2 flex items-center">
                    <i class="fas fa-keyboard text-gray-600 mr-2"></i>
                    Manual Entry
                </h4>
                <p class="text-sm text-gray-600 mb-2">
                    If you can't scan the QR code, enter this secret key manually:
                </p>
                <div class="flex items-center">
                    <code class="bg-gray-100 px-3 py-2 rounded font-mono text-sm flex-1">
                        {{ secret }}
                    </code>
                    <button onclick="copySecret()" 
                            class="ml-2 bg-gray-600 text-white px-3 py-2 rounded hover:bg-gray-700 transition">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 3: Verify Code -->
        <div>
            <div class="flex items-center mb-4">
                <div class="w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center mr-3">
                    <span class="text-white font-bold">3</span>
                </div>
                <h3 class="text-xl font-bold text-gray-900">Verify Setup</h3>
            </div>
            
            <form class="space-y-6" action="/enable-2fa" method="POST">
                <div>
                    <label for="totp_code" class="block text-sm font-medium text-gray-700 mb-1">
                        6-Digit Verification Code
                    </label>
                    <input type="text" id="totp_code" name="totp_code" required
                           class="block w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition duration-150 text-center text-xl font-mono tracking-widest"
                           placeholder="000000"
                           maxlength="6"
                           pattern="[0-9]{6}"
                           autocomplete="one-time-code">
                    <p class="text-xs text-gray-500 mt-1">
                        Enter the 6-digit code from your authenticator app
                    </p>
                </div>

                <!-- Security Backup -->
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-yellow-700">
                                <strong>Important:</strong> Save your backup codes in a secure place. 
                                If you lose access to your authenticator app, you'll need these codes to access your account.
                            </p>
                            <button type="button" onclick="showBackupCodes()" 
                                    class="mt-2 text-yellow-700 hover:text-yellow-900 text-sm font-medium">
                                <i class="fas fa-key mr-1"></i>Show Backup Codes
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="pt-4">
                    <button type="submit"
                            class="w-full bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition duration-150 font-medium">
                        <i class="fas fa-check-circle mr-2"></i>
                        Enable Two-Factor Authentication
                    </button>
                </div>

                <!-- Cancel Link -->
                <div class="text-center pt-4">
                    <a href="/profile" class="text-gray-600 hover:text-gray-900 font-medium">
                        <i class="fas fa-times mr-1"></i>
                        Cancel Setup
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Security Information -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
            <i class="fas fa-info-circle text-blue-500 mr-2"></i>
            About Two-Factor Authentication
        </h3>
        <div class="space-y-4">
            <div class="flex items-start">
                <i class="fas fa-check text-green-500 mt-1 mr-3"></i>
                <div>
                    <p class="font-medium text-gray-900">Enhanced Security</p>
                    <p class="text-sm text-gray-600">Protects your account even if your password is compromised</p>
                </div>
            </div>
            <div class="flex items-start">
                <i class="fas fa-check text-green-500 mt-1 mr-3"></i>
                <div>
                    <p class="font-medium text-gray-900">Required for Admins</p>
                    <p class="text-sm text-gray-600">All administrative accounts must have 2FA enabled</p>
                </div>
            </div>
            <div class="flex items-start">
                <i class="fas fa-check text-green-500 mt-1 mr-3"></i>
                <div>
                    <p class="font-medium text-gray-900">Easy to Use</p>
                    <p class="text-sm text-gray-600">Quick verification each time you sign in</p>
                </div>
            </div>
            <div class="flex items-start">
                <i class="fas fa-check text-green-500 mt-1 mr-3"></i>
                <div>
                    <p class="font-medium text-gray-900">Recovery Options</p>
                    <p class="text-sm text-gray-600">Backup codes and recovery options available</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Backup Codes Modal -->
<div id="backupCodesModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Backup Codes</h3>
            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                <p class="text-sm text-gray-600 mb-2">
                    <strong>Save these codes in a secure place!</strong> Each code can be used only once.
                </p>
                <div class="grid grid-cols-2 gap-2 font-mono text-sm">
                    <div class="bg-white p-2 rounded border">A3B9C7D2E1</div>
                    <div class="bg-white p-2 rounded border">F8G4H6J2K9</div>
                    <div class="bg-white p-2 rounded border">L1M5N3P7Q0</div>
                    <div class="bg-white p-2 rounded border">R4S8T2U6V5</div>
                    <div class="bg-white p-2 rounded border">W9X3Y7Z1A4</div>
                    <div class="bg-white p-2 rounded border">B6C2D8E0F3</div>
                </div>
            </div>
            <div class="flex justify-between">
                <button onclick="printBackupCodes()" 
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md">
                    <i class="fas fa-print mr-1"></i>Print
                </button>
                <button onclick="hideBackupCodes()"
                        class="px-4 py-2 text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 rounded-md">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function copySecret() {
    const secret = document.querySelector('code').textContent;
    navigator.clipboard.writeText(secret).then(() => {
        alert('Secret key copied to clipboard!');
    });
}

function showBackupCodes() {
    document.getElementById('backupCodesModal').classList.remove('hidden');
}

function hideBackupCodes() {
    document.getElementById('backupCodesModal').classList.add('hidden');
}

function printBackupCodes() {
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>2FA Backup Codes - IqubLedger</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                h1 { color: #333; }
                .codes { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 20px 0; }
                .code { border: 1px solid #ccc; padding: 10px; text-align: center; font-family: monospace; }
                .warning { background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; margin: 20px 0; }
            </style>
        </head>
        <body>
            <h1>2FA Backup Codes - IqubLedger</h1>
            <div class="warning">
                <strong>⚠️ Important:</strong> Save these codes in a secure place. Each code can be used only once.
                If you lose access to your authenticator app, use these codes to sign in.
            </div>
            <div class="codes">
                <div class="code">A3B9C7D2E1</div>
                <div class="code">F8G4H6J2K9</div>
                <div class="code">L1M5N3P7Q0</div>
                <div class="code">R4S8T2U6V5</div>
                <div class="code">W9X3Y7Z1A4</div>
                <div class="code">B6C2D8E0F3</div>
            </div>
            <p>Generated: ${new Date().toLocaleDateString()}</p>
            <p>Account: Your IqubLedger Account</p>
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

// Auto-focus on code input
document.addEventListener('DOMContentLoaded', function() {
    const codeInput = document.getElementById('totp_code');
    if (codeInput) {
        codeInput.focus();
        
        // Auto-submit when 6 digits entered
        codeInput.addEventListener('input', function(e) {
            const code = this.value.replace(/\s/g, '');
            if (code.length === 6) {
                // Auto-submit after short delay
                setTimeout(() => {
                    this.form.submit();
                }, 500);
            }
        });
    }
});
</script>
{% endblock %}
